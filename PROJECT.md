# pers.coach ‚Äî Shadow Training Platform

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

**pers.coach** ‚Äî –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä–æ–≤ —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ "–¥–æ–º–∞—à–∫–∞–º–∏" –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤.

–ö–∞–∂–¥—ã–π —Ç—Ä–µ–Ω–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–π –º–∏–Ω–∏—Å–∞–π—Ç –Ω–∞ –ø–æ–¥–¥–æ–º–µ–Ω–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä `anna.pers.coach`).

---

## Workflow —Ç—Ä–µ–Ω–µ—Ä–∞ (Offline processing –Ω–∞ Lightning.AI GPU)

1. **–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ** ‚Äî —Ç—Ä–µ–Ω–µ—Ä –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ "–¥–æ–º–∞" –≤–∏–¥–µ–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ GPU (Lightning.AI):**
   - üé¨ **–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ–Ω–∞** (MODNet) ‚Üí –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π WebM
   - üé® **V11 Color Correction** ‚Äî —Å—Ç—É–¥–∏–π–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ (brightness, contrast, LAB lift, warmth)
   - ü¶¥ **3D Pose Estimation** (SAM 3D Body / MediaPipe) ‚Üí JSON —Å 3D landmarks
   - üìÅ –í—ã—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã:
     - `trainer_transparent.webm` ‚Äî –≤–∏–¥–µ–æ —Å –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª–æ–º
     - `trainer_poses.json` ‚Äî 3D –ø–æ–∑—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
     - `trainer_poses.npz` ‚Äî –¥–∞–Ω–Ω—ã–µ –¥–ª—è 3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
3. **–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫** ‚Äî —Ç—Ä–µ–Ω–µ—Ä —Å–æ–±–∏—Ä–∞–µ—Ç –∏–∑ –≥–æ—Ç–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é "–¥–æ–º–∞—à–∫—É"

---

## Workflow –∫–ª–∏–µ–Ω—Ç–∞ (Real-time, –±—Ä–∞—É–∑–µ—Ä)

### Shadow Mode ‚Äî –≥–ª–∞–≤–Ω–∞—è —Ñ–∏—á–∞

–ö–ª–∏–µ–Ω—Ç —Å–º–æ—Ç—Ä–∏—Ç –≤–∏–¥–µ–æ —Ç—Ä–µ–Ω–µ—Ä–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –∞ –ø–æ–≤–µ—Ä—Ö –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –µ–≥–æ "—Ç–µ–Ω—å" —Å –≤–µ–±–∫–∞–º–µ—Ä—ã:
- **–í–∏–¥–µ–æ —Ç—Ä–µ–Ω–µ—Ä–∞** (–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ: –±–µ–∑ —Ñ–æ–Ω–∞, —Å—Ç—É–¥–∏–π–Ω—ã–π —Å–≤–µ—Ç) –Ω–∞ —Å–µ—Ä–æ–º —Ñ–æ–Ω–µ
- **–°–∏–ª—É—ç—Ç –∫–ª–∏–µ–Ω—Ç–∞** (–≤—ã—Ä–µ–∑–∞–Ω–Ω—ã–π —Ñ–æ–Ω) —Ä—è–¥–æ–º —Å —Ç—Ä–µ–Ω–µ—Ä–æ–º
- **–°–∫–µ–ª–µ—Ç —Ç—Ä–µ–Ω–µ—Ä–∞** ‚Äî –∏–∑ –ø—Ä–µ–¥—Ä–∞—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **–°–∫–µ–ª–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞** ‚Äî MediaPipe 3D Global Worldmarks (real-time)
- **Match Score** ‚Äî –ø—Ä–æ—Ü–µ–Ω—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ–∑

### –û—Ç—á—ë—Ç –¥–ª—è —Ç—Ä–µ–Ω–µ—Ä–∞

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è "–¥–æ–º–∞—à–∫–∏" —Ç—Ä–µ–Ω–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç:
- üìä % —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏–π —Å —ç—Ç–∞–ª–æ–Ω–æ–º
- üé• –í–∏–¥–µ–æ –∫–ª–∏–µ–Ω—Ç–∞ —Å —Ü–≤–µ—Ç–Ω–æ–π –ø–æ–ª–æ—Å–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:
  - üü¢ –ó–µ–ª—ë–Ω—ã–π ‚Äî —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç—Ä–µ–Ω–µ—Ä–æ–º
  - üî¥ –ö—Ä–∞—Å–Ω—ã–π ‚Äî –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
- üìù –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–∑–±–æ—Ä–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ

---

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

### Offline (—Å–µ—Ä–≤–µ—Ä, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ —Ç—Ä–µ–Ω–µ—Ä–∞)
- **Background Removal:** MODNet, BiRefNet
- **Relighting:** IC-Light (Stable Diffusion based) ‚Äî –∫–∞—á–µ—Å—Ç–≤–æ –≤–∞–∂–Ω–µ–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
- **3D Pose Estimation:** SAM-3D-Body, RTMPose ‚Äî –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã
- **Video Segmentation:** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Ä–µ–∑–∫–∞ –ø–æ –¥–≤–∏–∂–µ–Ω–∏—è–º

### Real-time (–±—Ä–∞—É–∑–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞)
- **MediaPipe Tasks Vision (v0.10.14)**
- **PoseLandmarker** ‚Äî 33 —Ç–æ—á–∫–∏ —Å–∫–µ–ª–µ—Ç–∞ (3D World Landmarks)
- **ImageSegmenter** (Selfie Segmenter) ‚Äî –º–∞—Å–∫–∞ —Ç–µ–ª–∞ –∫–ª–∏–µ–Ω—Ç–∞
- –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ WebAssembly + WebGL (GPU)

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      MAIN CANVAS                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                       ‚îÇ
‚îÇ  ‚îÇ  Trainer Video   ‚îÇ  ‚Üê HTML5 <video> element              ‚îÇ
‚îÇ  ‚îÇ  (background)    ‚îÇ                                       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                       ‚îÇ
‚îÇ           ‚Üë                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                       ‚îÇ
‚îÇ  ‚îÇ  Canvas Overlay  ‚îÇ  ‚Üê Skeleton + Shadow —Ä–∏—Å—É—é—Ç—Å—è –∑–¥–µ—Å—å   ‚îÇ
‚îÇ  ‚îÇ  - Trainer skel  ‚îÇ     (–∫—Ä–∞—Å–Ω—ã–π)                         ‚îÇ
‚îÇ  ‚îÇ  - Client shadow ‚îÇ     (–∑–µ–ª—ë–Ω–∞—è –º–∞—Å–∫–∞)                   ‚îÇ
‚îÇ  ‚îÇ  - Client skel   ‚îÇ     (–∑–µ–ª—ë–Ω—ã–π, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
/Users/user/Documents/pers2/
‚îú‚îÄ‚îÄ index.html                    # UI: video player, canvas, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îú‚îÄ‚îÄ app.js                        # –õ–æ–≥–∏–∫–∞ MediaPipe, —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ squat.mp4                     # –ò—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ —Ç—Ä–µ–Ω–µ—Ä–∞
‚îú‚îÄ‚îÄ squat_cropped.mp4             # –û–±—Ä–µ–∑–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ (602x722, 30fps)
‚îú‚îÄ‚îÄ PROJECT.md                    # –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îÇ
‚îú‚îÄ‚îÄ extract_3d_pose.py            # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ 3D –ø–æ–∑—ã –∏–∑ –≤–∏–¥–µ–æ (SAM 3D Body)
‚îú‚îÄ‚îÄ lightning_trainer_pipeline.ipynb  # Notebook –¥–ª—è Lightning.AI (MODNet + V11)
‚îú‚îÄ‚îÄ autocrop_video.py             # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–µ–∑–∫–∞ –≤–∏–¥–µ–æ
‚îÇ
‚îú‚îÄ‚îÄ output/
‚îÇ   ‚îú‚îÄ‚îÄ trainer_transparent.webm  # –í–∏–¥–µ–æ —Å –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º —Ñ–æ–Ω–æ–º (VP9 + alpha)
‚îÇ   ‚îú‚îÄ‚îÄ trainer_frames/           # PNG –∫–∞–¥—Ä—ã —Å –∞–ª—å—Ñ–∞-–∫–∞–Ω–∞–ª–æ–º
‚îÇ   ‚îú‚îÄ‚îÄ test_transparent.html     # –¢–µ—Å—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–≥–æ –≤–∏–¥–µ–æ
‚îÇ   ‚îî‚îÄ‚îÄ poses/                    # 3D –ø–æ–∑—ã —Ç—Ä–µ–Ω–µ—Ä–∞
‚îÇ       ‚îú‚îÄ‚îÄ trainer_poses.json    # –î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
‚îÇ       ‚îî‚îÄ‚îÄ trainer_poses.npz     # –î–ª—è 3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
‚îÇ
‚îú‚îÄ‚îÄ MODNet/                       # –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ–Ω–∞
‚îú‚îÄ‚îÄ sam-3d-body/                  # 3D Pose Estimation (Meta AI)
‚îî‚îÄ‚îÄ checkpoints/
    ‚îî‚îÄ‚îÄ sam-3d-body-dinov3/       # –í–µ—Å–∞ SAM 3D Body
```

---

## index.html ‚Äî UI

### Layout (CSS Grid)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   SIDEBAR    ‚îÇ           VIDEO CONTAINER           ‚îÇ
‚îÇ   (280px)    ‚îÇ              (1fr)                  ‚îÇ
‚îÇ              ‚îÇ                                     ‚îÇ
‚îÇ  - Logo      ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  - Status    ‚îÇ    ‚îÇ                         ‚îÇ     ‚îÇ
‚îÇ  - Webcam*   ‚îÇ    ‚îÇ     Trainer Video       ‚îÇ     ‚îÇ
‚îÇ  - Settings  ‚îÇ    ‚îÇ     + Canvas Overlay    ‚îÇ     ‚îÇ
‚îÇ  - Stats     ‚îÇ    ‚îÇ                         ‚îÇ     ‚îÇ
‚îÇ  - Button    ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îÇ              ‚îÇ                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
* Webcam preview —Å–∫—Ä—ã—Ç (display: none) –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
```

### –≠–ª–µ–º–µ–Ω—Ç—ã
- **Logo**: `anna.pers.coach` (–ø—Ä–∏–º–µ—Ä –ø–æ–¥–¥–æ–º–µ–Ω–∞ —Ç—Ä–µ–Ω–µ—Ä–∞)
- **Status Badge**: "Shadow Mode" —Å –ø—É–ª—å—Å–∏—Ä—É—é—â–µ–π —Ç–æ—á–∫–æ–π
- **Settings Panel**: Toggle –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏
  - –¢–µ–Ω—å –∫–ª–∏–µ–Ω—Ç–∞ (showShadow)
  - –°–∫–µ–ª–µ—Ç —Ç—Ä–µ–Ω–µ—Ä–∞ (showTrainerSkeleton)
  - –°–∫–µ–ª–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ (showClientSkeleton)
  - –ê–≤—Ç–æ–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ (autoAlign)
- **Stats Panel**: Match Score (%) –∏ FPS
- **Start Button**: –ó–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ–±–∫–∞–º–µ—Ä—ã –∏ –≤–∏–¥–µ–æ

### CSS –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º–∏ (#0a0a0f ‚Üí #1a1a2e)
- –ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç: #00ff88 (–∑–µ–ª—ë–Ω—ã–π)
- –®—Ä–∏—Ñ—Ç: Outfit (Google Fonts)
- Canvas —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ–≤–µ—Ä—Ö –≤–∏–¥–µ–æ —Å `transform: translate(-50%, -50%)`

---

## app.js ‚Äî –õ–æ–≥–∏–∫–∞

### State (–≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
```javascript
const state = {
    trainerPoseLandmarker: null,  // MediaPipe –¥–ª—è –≤–∏–¥–µ–æ —Ç—Ä–µ–Ω–µ—Ä–∞
    clientPoseLandmarker: null,   // MediaPipe –¥–ª—è –≤–µ–±–∫–∞–º–µ—Ä—ã (–æ—Ç–¥–µ–ª—å–Ω—ã–π!)
    imageSegmenter: null,         // –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è —Ç–µ–ª–∞ –∫–ª–∏–µ–Ω—Ç–∞
    webcamRunning: false,
    trainerPose: null,            // 33 landmarks —Ç—Ä–µ–Ω–µ—Ä–∞
    clientPose: null,             // 33 landmarks –∫–ª–∏–µ–Ω—Ç–∞
    clientMask: null,             // –ú–∞—Å–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏
    
    // Timestamps –¥–ª—è MediaPipe (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞—é—â–∏–º–∏!)
    lastTrainerTimestamp: 0,
    lastClientPoseTimestamp: 0,
    lastClientSegTimestamp: 0,
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –∫–∞–∂–¥—ã–π N –∫–∞–¥—Ä
    frameCount: 0,
    segmentationInterval: 3,
    
    settings: { showShadow, showTrainerSkeleton, showClientSkeleton, autoAlign },
    fps: { frames, lastTime, value }
};
```

### –ö–ª—é—á–µ–≤—ã–µ landmarks –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
```javascript
const ALIGNMENT_LANDMARKS = {
    nose: 0,
    leftShoulder: 11,
    rightShoulder: 12,
    leftHip: 23,
    rightHip: 24,
    leftAnkle: 27,
    rightAnkle: 28,
    leftHeel: 29,
    rightHeel: 30
};
```

### POSE_CONNECTIONS (–¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è —Å–∫–µ–ª–µ—Ç–∞)
```javascript
[
    [11, 12],  // –ø–ª–µ—á–∏
    [11, 13], [13, 15],  // –ª–µ–≤–∞—è —Ä—É–∫–∞
    [12, 14], [14, 16],  // –ø—Ä–∞–≤–∞—è —Ä—É–∫–∞
    [11, 23], [12, 24],  // —Ç–æ—Ä—Å
    [23, 24],  // –±—ë–¥—Ä–∞
    [23, 25], [25, 27], [27, 29], [29, 31],  // –ª–µ–≤–∞—è –Ω–æ–≥–∞
    [24, 26], [26, 28], [28, 30], [30, 32],  // –ø—Ä–∞–≤–∞—è –Ω–æ–≥–∞
]
```

---

## –ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ Aspect Ratio
- –í–∏–¥–µ–æ —Ç—Ä–µ–Ω–µ—Ä–∞: –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ (9:16, ~0.5625)
- –í–µ–±–∫–∞–º–µ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è (16:9 –∏–ª–∏ 4:3, ~1.33-1.78)

### –†–µ—à–µ–Ω–∏–µ –¥–ª—è —Å–∫–µ–ª–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞
```javascript
// –í—ã—á–∏—Å–ª—è–µ–º –∫–∞–∫ webcam –º–∞–ø–ø–∏—Ç—Å—è –Ω–∞ canvas
if (webcamAspect > trainerAspect) {
    // Webcam —à–∏—Ä–µ ‚Äî –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º X
    scaleX = webcamAspect / trainerAspect;
    scaleY = 1;
    offsetX = (1 - scaleX) / 2;  // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º
    offsetY = 0;
} else {
    // Webcam —É–∂–µ ‚Äî –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º Y
    scaleX = 1;
    scaleY = trainerAspect / webcamAspect;
    offsetX = 0;
    offsetY = (1 - scaleY) / 2;
}

// –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é —Ç–æ—á–∫—É —Å–∫–µ–ª–µ—Ç–∞
x = 1 - lm.x;  // –ó–µ—Ä–∫–∞–ª–∏–º (webcam –æ—Ç–∑–µ—Ä–∫–∞–ª–µ–Ω–∞)
y = lm.y;
x = offsetX + x * scaleX;
y = offsetY + y * scaleY;
```

### –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ç—Ä–µ–Ω–µ—Ä—É (calculateAlignmentTransform)
```javascript
// –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
trainerCenter = —Å—Ä–µ–¥–Ω–µ–µ(–ø–ª–µ—á–∏ + –±—ë–¥—Ä–∞) —Ç—Ä–µ–Ω–µ—Ä–∞
clientCenter = —Å—Ä–µ–¥–Ω–µ–µ(–ø–ª–µ—á–∏ + –±—ë–¥—Ä–∞) –∫–ª–∏–µ–Ω—Ç–∞ (–ø–æ—Å–ª–µ aspect ratio –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏)
trainerSize = —à–∏—Ä–∏–Ω–∞_–ø–ª–µ—á + –≤—ã—Å–æ—Ç–∞_—Ç–æ—Ä—Å–∞ —Ç—Ä–µ–Ω–µ—Ä–∞
clientSize = —à–∏—Ä–∏–Ω–∞_–ø–ª–µ—á + –≤—ã—Å–æ—Ç–∞_—Ç–æ—Ä—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞

// –†–µ–∑—É–ª—å—Ç–∞—Ç
scale = trainerSize / clientSize  // –ú–∞—Å—à—Ç–∞–± (0.5 - 2.5)
offsetX = trainerCenter.x - clientCenter.x
offsetY = trainerCenter.y - clientCenter.y

// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫ —Å–∫–µ–ª–µ—Ç—É –∫–ª–∏–µ–Ω—Ç–∞
finalX = trainerCenterX + (x - clientCenterX) * scale
finalY = trainerCenterY + (y - clientCenterY) * scale
```

### –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–Ω–∏ (drawShadow)
```javascript
ctx.save();

// 1. –ó–µ—Ä–∫–∞–ª–∏–º
ctx.translate(canvasWidth, 0);
ctx.scale(-1, 1);

// 2. –°–º–µ—â–∞–µ–º (X –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –∏–∑-–∑–∞ –∑–µ—Ä–∫–∞–ª–∞!)
ctx.translate(-offsetX * canvasWidth, offsetY * canvasHeight);

// 3. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –≤–æ–∫—Ä—É–≥ —Ü–µ–Ω—Ç—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞
ctx.translate(clientCenterX, clientCenterY);
ctx.scale(scale, scale);
ctx.translate(-clientCenterX, -clientCenterY);

// 4. –†–∏—Å—É–µ–º –º–∞—Å–∫—É —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π webcam
ctx.drawImage(shadowCanvas, drawX, drawY, drawWidth, drawHeight);

ctx.restore();
```

---

## –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è (–º–∞—Å–∫–∞ —Ç–µ–ª–∞)

### –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö
- `ImageSegmenter.segmentForVideo()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `categoryMask`
- `mask.getAsUint8Array()` ‚Äî –º–∞—Å—Å–∏–≤ –±–∞–π—Ç–æ–≤
- **0 = —Ç–µ–ª–æ (person)**, non-zero = —Ñ–æ–Ω

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
```javascript
// –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π canvas
let shadowCanvas = null;

// –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å–∫—É –∫–∞–∂–¥—ã–π N –∫–∞–¥—Ä
if (frameCount % segmentationInterval === 0) {
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—é
}

// –ë—ã—Å—Ç—Ä—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏
for (let i = 0; i < len; i++) {
    const idx = i << 2;  // –ë—ã—Å—Ç—Ä–µ–µ —á–µ–º i * 4
    if (maskData[i] === 0) {  // –¢–µ–ª–æ
        data[idx] = 0;       // R
        data[idx + 1] = 255; // G
        data[idx + 2] = 136; // B
        data[idx + 3] = 90;  // A (–ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å)
    }
}
```

---

## Match Score (–æ—Ü–µ–Ω–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è)

```javascript
function calculateMatchScore(trainerPose, clientPose) {
    const keyLandmarks = [11,12,13,14,15,16,23,24,25,26,27,28];
    let totalDistance = 0;
    
    for (const idx of keyLandmarks) {
        const dx = trainerPose[idx].x - clientPose[idx].x;
        const dy = trainerPose[idx].y - clientPose[idx].y;
        totalDistance += Math.sqrt(dx*dx + dy*dy);
    }
    
    const avgDistance = totalDistance / count;
    const score = (1 - avgDistance * 2) * 100;  // 0-100%
    return Math.max(0, Math.min(100, score));
}

// –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è
score > 70  ‚Üí –∑–µ–ª—ë–Ω—ã–π (#00ff88)
score > 40  ‚Üí –∂—ë–ª—Ç—ã–π (#ffaa00)
score <= 40 ‚Üí –∫—Ä–∞—Å–Ω—ã–π (#ff4444)
```

---

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### 1. Timestamp errors –≤ MediaPipe
**–ü—Ä–æ–±–ª–µ–º–∞**: `INVALID_ARGUMENT: Packet timestamp mismatch`
**–†–µ—à–µ–Ω–∏–µ**: –û—Ç–¥–µ–ª—å–Ω—ã–µ PoseLandmarker –¥–ª—è —Ç—Ä–µ–Ω–µ—Ä–∞ –∏ –∫–ª–∏–µ–Ω—Ç–∞ + –æ—Ç–¥–µ–ª—å–Ω—ã–µ timestamp trackers

### 2. –ù–∏–∑–∫–∏–π FPS
**–†–µ—à–µ–Ω–∏–µ**: 
- –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –∫–∞–∂–¥—ã–π 3-–π –∫–∞–¥—Ä
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ canvas –¥–ª—è –º–∞—Å–∫–∏
- –°–∫—Ä—ã—Ç–∏–µ webcam preview (display: none)

### 3. –°–∂–∞—Ç—ã–π —Å–∫–µ–ª–µ—Ç/—Ç–µ–Ω—å
**–ü—Ä–∏—á–∏–Ω–∞**: –†–∞–∑–Ω—ã–π aspect ratio webcam vs trainer video
**–†–µ—à–µ–Ω–∏–µ**: –û—Ç–¥–µ–ª—å–Ω–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Å —É—á—ë—Ç–æ–º aspect ratio

### 4. –ò–Ω–≤–µ—Ä—Å–∏—è –º–∞—Å–∫–∏
**–ü—Ä–∏—á–∏–Ω–∞**: –í Selfie Segmenter 0 = person (–Ω–µ background)
**–†–µ—à–µ–Ω–∏–µ**: `if (maskData[i] === 0)` –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–µ–ª–∞

---

## –ó–∞–ø—É—Å–∫

```bash
cd /Users/user/Documents/pers2
python3 -m http.server 8080
# –û—Ç–∫—Ä—ã—Ç—å http://localhost:8080
```

**–í–∞–∂–Ω–æ**: –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ localhost –∏–ª–∏ HTTPS (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ)

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (TODO)

1. [x] ~~–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ–Ω–∞ (MODNet)~~
2. [x] ~~V11 Color Correction~~
3. [x] ~~WebM —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é~~
4. [x] ~~3D Pose Extraction (SAM 3D Body –Ω–∞ Lightning.AI)~~
5. [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–≥–æ –≤–∏–¥–µ–æ –≤ –±—Ä–∞—É–∑–µ—Ä
6. [ ] 3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–µ–ª–µ—Ç–∞ —Ç—Ä–µ–Ω–µ—Ä–∞ (Three.js)
7. [ ] –°—Ä–∞–≤–Ω–µ–Ω–∏–µ 3D –ø–æ–∑ —Ç—Ä–µ–Ω–µ—Ä–∞ –∏ –∫–ª–∏–µ–Ω—Ç–∞
8. [ ] –ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
9. [ ] –ê—É–¥–∏–æ-—Ñ–∏–¥–±–µ–∫ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –æ—Ç –ø–æ–∑—ã
10. [ ] Backend –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

---

## Lightning.AI Setup

### –ê–∫–∫–∞—É–Ω—Ç
- Email: mshagiev@gmail.com
- Free tier: 15 –∫—Ä–µ–¥–∏—Ç–æ–≤/–º–µ—Å—è—Ü (~80 GPU —á–∞—Å–æ–≤)
- Studio ID: `s_01kbm748xt78mk87pbz5p7c5dm`

### GPU Pricing
| GPU | VRAM | –¶–µ–Ω–∞/—á–∞—Å |
|-----|------|----------|
| T4 | 16 GB | $0.19 |
| L4 | 24 GB | $0.48 |
| A100 | 40 GB | $1.29 |

### –ó–∞–¥–∞—á–∏ –Ω–∞ Lightning.AI

#### –ó–∞–¥–∞—á–∞ 1: MODNet + V11 (‚úÖ –ì–û–¢–û–í–û)
- –§–∞–π–ª: `lightning_trainer_pipeline.ipynb`
- –í—Ä–µ–º—è: ~10 –º–∏–Ω –Ω–∞ T4
- –†–µ–∑—É–ª—å—Ç–∞—Ç: `output/trainer_transparent.webm` (62 MB)

#### –ó–∞–¥–∞—á–∞ 2: SAM 3D Body Pose Extraction (‚úÖ –ì–û–¢–û–í–û)
- –§–∞–π–ª: `extract_3d_pose.py`
- –í—Ä–µ–º—è: ~20 –º–∏–Ω –Ω–∞ T4
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
  - `output/poses/trainer_poses.json` (50 MB) ‚Äî 2897 –∫–∞–¥—Ä–æ–≤ —Å 3D –ø–æ–∑–∞–º–∏
  - `output/poses/trainer_poses.npz` (8.4 MB) ‚Äî –¥–ª—è 3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏

### –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
–°–º. `LIGHTNING_SETUP_GUIDE.md` ‚Äî –ø–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Å–µ—Ä–≤–µ—Ä–∞



